<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>教育費シミュレーター</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg1: #f5fbff;
      --bg2: #fff7f0;
      --card-bg: #ffffff;
      --primary: #1976d2;
      --primary-light: #e3f2fd;
      --danger: #d32f2f;
      --text-main: #222222;
      --text-sub: #666666;
      --border-soft: #e0e0e0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text-main);
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 4px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-sub);
      text-align: center;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .form-helper {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-top: 2px;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      font-size: 0.9rem;
      outline: none;
      background-color: #fafafa;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-light);
      background-color: #ffffff;
    }

    .section-label {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 12px 0 6px;
    }

    .error-message {
      font-size: 0.8rem;
      color: var(--danger);
      margin-bottom: 8px;
    }

    .btn-primary {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, #1976d2, #42a5f5);
      cursor: pointer;
      margin-top: 8px;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12) inset;
    }

    .btn-secondary {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background-color: #ffffff;
      padding: 10px;
      font-size: 0.85rem;
      color: var(--text-sub);
      cursor: pointer;
      margin-top: 4px;
    }

    .btn-secondary-pressed {
      border-color: var(--primary);
      color: var(--primary);
      background-color: #f3f7ff;
    }

    /* 幼〜高のラジオ行 */
    .grade-radio-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .grade-radio-label {
      font-size: 0.85rem;
      min-width: 70px;
    }

    .radio-group {
      display: flex;
      gap: 8px;
      flex: 1;
      justify-content: flex-end;
    }

    .radio-option {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background-color: #fafafa;
    }

    .radio-option input[type="radio"] {
      margin: 0;
    }

    .advanced-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background-color: #fafafa;
      margin-bottom: 8px;
    }

    .advanced-item input[type="checkbox"] {
      margin-top: 4px;
    }

    .advanced-label {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .advanced-desc {
      font-size: 0.75rem;
      color: var(--text-sub);
      line-height: 1.4;
    }

    .result-main {
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .result-highlight {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
    }

    .result-name {
      font-weight: 600;
    }

    .result-sub {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .result-table th,
    .result-table td {
      padding: 6px 4px;
      border-bottom: 1px solid var(--border-soft);
      text-align: right;
    }

    .result-table th:first-child,
    .result-table td:first-child {
      text-align: left;
    }

    .result-table thead th {
      font-weight: 600;
      color: var(--text-sub);
      background-color: #fafafa;
    }

    .result-note {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-top: 10px;
      line-height: 1.5;
    }

    @media (min-width: 600px) {
      body {
        padding: 24px;
      }
      h1 {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>教育費シミュレーター</h1>
      <p class="subtitle">
        幼稚園〜高校の公立・私立、大学の種類・一人暮らしなどを選ぶだけで、<br>
        これからかかる教育費をざっくり試算します。
      </p>
    </header>

    <!-- 基本情報 -->
    <section class="card" id="input-card">
      <div class="card-title">子どもの基本情報</div>

      <div id="error-area" class="error-message" style="display:none;"></div>

      <div class="form-group">
        <label for="child-name">名前（ニックネームでもOK）</label>
        <input id="child-name" type="text" placeholder="例）太郎">
        <div class="form-helper">未入力の場合は「子ども1」として表示します。</div>
      </div>

      <div class="form-group">
        <label for="current-grade">今の学年</label>
        <select id="current-grade">
          <option value="">選択してください</option>
          <option value="0">未就学</option>
          <option value="1">年少</option>
          <option value="2">年中</option>
          <option value="3">年長</option>
          <option value="4">小1</option>
          <option value="5">小2</option>
          <option value="6">小3</option>
          <option value="7">小4</option>
          <option value="8">小5</option>
          <option value="9">小6</option>
          <option value="10">中1</option>
          <option value="11">中2</option>
          <option value="12">中3</option>
          <option value="13">高1</option>
          <option value="14">高2</option>
          <option value="15">高3</option>
        </select>
        <div class="form-helper">これから先にかかる費用のみ試算します。</div>
      </div>
    </section>

    <!-- 進路選択 -->
    <section class="card">
      <div class="card-title">進路の想定</div>

      <div class="section-label">幼稚園〜高校（学校種別）</div>

      <div class="grade-radio-row">
        <div class="grade-radio-label">幼稚園</div>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="kindergarten-type" value="public" checked>
            <span>国公立</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="kindergarten-type" value="private">
            <span>私立</span>
          </label>
        </div>
      </div>

      <div class="grade-radio-row">
        <div class="grade-radio-label">小学校</div>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="elementary-type" value="public" checked>
            <span>国公立</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="elementary-type" value="private">
            <span>私立</span>
          </label>
        </div>
      </div>

      <div class="grade-radio-row">
        <div class="grade-radio-label">中学校</div>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="junior-type" value="public" checked>
            <span>国公立</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="junior-type" value="private">
            <span>私立</span>
          </label>
        </div>
      </div>

      <div class="grade-radio-row">
        <div class="grade-radio-label">高校</div>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="high-type" value="public" checked>
            <span>国公立</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="high-type" value="private">
            <span>私立</span>
          </label>
        </div>
      </div>

      <div class="section-label">大学・その後</div>

      <div class="form-group">
        <label for="sel-university">大学の進路</label>
        <select id="sel-university">
          <option value="none">大学には進学しない（専門・就職など）</option>
          <option value="national">国公立大学</option>
          <option value="private_arts">私立大学（文系）</option>
          <option value="private_science">私立大学（理系）</option>
        </select>
      </div>

      <div class="form-group">
        <label for="sel-living">大学在学中の居住</label>
        <select id="sel-living">
          <option value="home">自宅から通学</option>
          <option value="local_rent">地方都市で一人暮らし</option>
          <option value="tokyo_rent">首都圏で一人暮らし</option>
        </select>
        <div class="form-helper">大学に進学しない場合、この設定は無視されます。</div>
      </div>

      <div class="form-group">
        <label for="sel-grad">大学院進学</label>
        <select id="sel-grad">
          <option value="no">大学院には進学しない</option>
          <option value="yes">大学院まで進学する（2年）</option>
        </select>
      </div>

      <!-- 詳細オプションのトグルボタン -->
      <button type="button" class="btn-secondary" id="toggle-advanced-btn" onclick="toggleAdvanced()">
        さらに詳しく（塾・習い事など）を設定する
      </button>
    </section>

    <!-- 詳細オプション（折りたたみ） -->
    <section class="card" id="advanced-card" style="display:none;">
      <div class="card-title">塾・予備校・習い事（任意）</div>
      <p class="form-helper" style="margin-bottom: 8px;">
        金額は一般的な目安で固定しています。チェックすると、その費用を加算します。
      </p>

      <label class="advanced-item">
        <input type="checkbox" id="opt-juku-elem">
        <div>
          <div class="advanced-label">小学生の塾</div>
          <div class="advanced-desc">
            小5〜小6の2年間、月1.5万円程度の通塾を想定（年18万円 × 最大2年程度）。
          </div>
        </div>
      </label>

      <label class="advanced-item">
        <input type="checkbox" id="opt-juku-jh">
        <div>
          <div class="advanced-label">中学生の塾</div>
          <div class="advanced-desc">
            中1〜中3の3年間、月2.5万円程度の通塾を想定（年30万円 × 最大3年程度）。
          </div>
        </div>
      </label>

      <label class="advanced-item">
        <input type="checkbox" id="opt-yobikou">
        <div>
          <div class="advanced-label">高校の予備校</div>
          <div class="advanced-desc">
            高2〜高3の2年間、月4万円程度の予備校を想定（年48万円 × 最大2年程度）。
          </div>
        </div>
      </label>

      <label class="advanced-item">
        <input type="checkbox" id="opt-lessons">
        <div>
          <div class="advanced-label">習い事（合計）</div>
          <div class="advanced-desc">
            小1〜小6の6年間、月1万円程度の習い事を想定（年12万円 × 最大6年程度）。
          </div>
        </div>
      </label>
    </section>

    <!-- 計算ボタン -->
    <section class="card">
      <button class="btn-primary" onclick="handleCalculate()">教育費を試算する</button>
    </section>

    <!-- 結果カード -->
    <section class="card" id="result-card" style="display:none;">
      <div class="card-title">試算結果</div>
      <div class="result-main" id="result-main-text"></div>
      <div class="result-sub" id="result-sub-text"></div>

      <table class="result-table" id="breakdown-table">
        <thead>
          <tr>
            <th>区分</th>
            <th>年数</th>
            <th>年額</th>
            <th>小計</th>
          </tr>
        </thead>
        <tbody>
          <!-- JSで挿入 -->
        </tbody>
      </table>

      <p class="result-note">
        ・上記はあくまで目安のモデルです。地域・学校・進路によって大きく変動します。<br>
        ・幼児〜高校の学校教育費、および塾・習い事・一人暮らし費用の一般的な水準を参考に、便宜的なモデルとして設定しています。
      </p>
    </section>
  </div>

  <script>
    // 学年インデックスの定義（0〜15）
    // 0: 未就学, 1-3: 年少〜年長, 4-9: 小1〜小6, 10-12: 中1〜中3, 13-15: 高1〜高3

    var stageRanges = {
      kindergarten: { start: 1, end: 3, label: "幼稚園" },
      elementary:   { start: 4, end: 9, label: "小学校" },
      junior_high:  { start: 10, end: 12, label: "中学校" },
      high_school:  { start: 13, end: 15, label: "高校" }
    };

    // 年間教育費モデル（1年あたり／円、ざっくり）
    var costModel = {
      kindergarten: {
        public: 300000,
        private: 600000
      },
      elementary: {
        public: 350000,
        private: 900000
      },
      // 中学校：公立55万／私立140万に引き上げ
      junior_high: {
        public: 550000,
        private: 1400000
      },
      high_school: {
        public: 450000,
        private: 900000
      },
      university: {
        national: 1000000,
        private_arts: 1200000,
        private_science: 1600000
      },
      graduate: {
        national: 1000000,
        private_arts: 1300000,
        private_science: 1800000
      },
      living: {
        home: 0,
        local_rent: 800000,
        tokyo_rent: 1200000
      }
    };

    // 塾・習い事などの追加モデル
    // 小学生塾：小5 2万円／月、 小6 3万円／月
    // 中学生塾：中1 2.5万円／月、中2 3万円／月、中3 4万円／月
    var extrasModel = {
      jukuElem: {
        label: "小学生の塾（小5〜小6）",
        startIndex: 8,  // 小5
        endIndex: 9,    // 小6
        monthlyByGrade: {
          8: 20000,     // 小5
          9: 30000      // 小6
        }
      },
      jukuJh: {
        label: "中学生の塾（中1〜中3）",
        startIndex: 10, // 中1
        endIndex: 12,   // 中3
        monthlyByGrade: {
          10: 25000,    // 中1
          11: 30000,    // 中2
          12: 40000     // 中3
        }
      },
      yobikou: {
        label: "高校の予備校（高2〜高3）",
        startIndex: 14, // 高2
        endIndex: 15,   // 高3
        monthly: 40000
      },
      lessons: {
        label: "習い事（小1〜小6）",
        startIndex: 4,  // 小1
        endIndex: 9,    // 小6
        monthly: 10000
      }
    };

    // 子ども別の状態
    var childStates = [];
    var activeChildIndex = 0;

    function createDefaultChildState(idx) {
      return {
        name: "",
        gradeValue: "",
        kindergartenType: "public",
        elementaryType: "public",
        juniorType: "public",
        highType: "public",
        universityType: "none",
        livingType: "home",
        includeGraduate: false,
        advancedFlags: {
          jukuElem: false,
          jukuJh: false,
          yobikou: false,
          lessons: false
        }
      };
    }

    function initChildStates() {
      childStates = [];
      for (var i = 0; i < 4; i++) {
        childStates.push(createDefaultChildState(i));
      }
      activeChildIndex = 0;
    }

    function getRadioValue(name) {
      var el = document.querySelector('input[name="' + name + '"]:checked');
      return el ? el.value : "public";
    }

    function setRadioValue(name, value) {
      var selector = 'input[name="' + name + '"][value="' + value + '"]';
      var el = document.querySelector(selector);
      if (el) el.checked = true;
    }

    function saveCurrentFormToState() {
      var st = childStates[activeChildIndex];
      var nameInput = document.getElementById("child-name");
      var gradeSelect = document.getElementById("current-grade");

      st.name = nameInput.value.trim();
      st.gradeValue = gradeSelect.value;

      st.kindergartenType = getRadioValue("kindergarten-type");
      st.elementaryType   = getRadioValue("elementary-type");
      st.juniorType       = getRadioValue("junior-type");
      st.highType         = getRadioValue("high-type");

      st.universityType = document.getElementById("sel-university").value;
      st.livingType     = document.getElementById("sel-living").value;
      st.includeGraduate = document.getElementById("sel-grad").value === "yes";

      st.advancedFlags.jukuElem = document.getElementById("opt-juku-elem").checked;
      st.advancedFlags.jukuJh   = document.getElementById("opt-juku-jh").checked;
      st.advancedFlags.yobikou  = document.getElementById("opt-yobikou").checked;
      st.advancedFlags.lessons  = document.getElementById("opt-lessons").checked;
    }

    function loadStateToForm() {
      var st = childStates[activeChildIndex];

      var nameInput = document.getElementById("child-name");
      var gradeSelect = document.getElementById("current-grade");

      nameInput.value = st.name || "";
      gradeSelect.value = st.gradeValue || "";

      setRadioValue("kindergarten-type", st.kindergartenType || "public");
      setRadioValue("elementary-type",   st.elementaryType   || "public");
      setRadioValue("junior-type",       st.juniorType       || "public");
      setRadioValue("high-type",         st.highType         || "public");

      document.getElementById("sel-university").value = st.universityType || "none";
      document.getElementById("sel-living").value     = st.livingType || "home";
      document.getElementById("sel-grad").value       = st.includeGraduate ? "yes" : "no";

      document.getElementById("opt-juku-elem").checked = !!st.advancedFlags.jukuElem;
      document.getElementById("opt-juku-jh").checked   = !!st.advancedFlags.jukuJh;
      document.getElementById("opt-yobikou").checked   = !!st.advancedFlags.yobikou;
      document.getElementById("opt-lessons").checked   = !!st.advancedFlags.lessons;
    }

    function updateTabUI() {
      for (var i = 0; i < 4; i++) {
        var btn = document.getElementById("child-tab-" + i);
        if (!btn) continue;
        btn.classList.remove("tab-button-active");
        if (i === activeChildIndex) {
          btn.classList.add("tab-button-active");
        }
      }
    }

    function switchChild(idx) {
      // 現在の入力内容を保存
      saveCurrentFormToState();

      activeChildIndex = idx;
      updateTabUI();
      loadStateToForm();
      showError("");

      // 切り替え時は結果を一旦隠す（混乱防止）
      document.getElementById("result-card").style.display = "none";
      document.getElementById("family-card").style.display = "none";
    }

    function toggleAdvanced() {
      var card = document.getElementById("advanced-card");
      var btn = document.getElementById("toggle-advanced-btn");
      if (card.style.display === "none" || card.style.display === "") {
        card.style.display = "block";
        btn.classList.add("btn-secondary-pressed");
        btn.textContent = "詳細設定を閉じる";
      } else {
        card.style.display = "none";
        btn.classList.remove("btn-secondary-pressed");
        btn.textContent = "さらに詳しく（塾・習い事など）を設定する";
      }
    }

    function calcRemainingYearsForStage(currentIndex, stageKey) {
      var stage = stageRanges[stageKey];
      if (!stage) return 0;

      var start = stage.start;
      var end = stage.end;

      if (currentIndex < start) {
        return end - start + 1;
      }
      if (currentIndex > end) {
        return 0;
      }
      return end - currentIndex + 1;
    }

    // 追加費用（塾・予備校・習い事）を計算するヘルパー
    function calcExtras(currentIndex, extrasDef) {
      var start = extrasDef.startIndex;
      var end = extrasDef.endIndex;
      var subtotal = 0;
      var yearsCount = 0;

      for (var idx = start; idx <= end; idx++) {
        if (idx < currentIndex) continue; // すでに終わっている学年はスキップ

        var monthly = 0;
        if (extrasDef.monthlyByGrade && extrasDef.monthlyByGrade[idx]) {
          monthly = extrasDef.monthlyByGrade[idx];
        } else if (extrasDef.monthly) {
          monthly = extrasDef.monthly;
        } else {
          continue;
        }

        var annual = monthly * 12;
        subtotal += annual;
        yearsCount += 1;
      }

      if (subtotal <= 0 || yearsCount === 0) {
        return null;
      }

      var avgAnnual = Math.round(subtotal / yearsCount);

      return {
        years: yearsCount,
        annual: avgAnnual,
        subtotal: subtotal
      };
    }

    function calculateEducationCost(currentIndex, config, advancedFlags) {
      var breakdown = [];
      var total = 0;

      var stages = [
        { key: "kindergarten", typeKey: "kindergartenType", label: "幼稚園" },
        { key: "elementary",   typeKey: "elementaryType",   label: "小学校" },
        { key: "junior_high",  typeKey: "juniorHighType",   label: "中学校" },
        { key: "high_school",  typeKey: "highSchoolType",   label: "高校" }
      ];

      for (var i = 0; i < stages.length; i++) {
        var stage = stages[i];
        var schoolType = config[stage.typeKey];
        if (!schoolType || schoolType === "none") continue;

        var years = calcRemainingYearsForStage(currentIndex, stage.key);
        if (years <= 0) continue;

        var annual = costModel[stage.key][schoolType];
        var subtotal = annual * years;
        total += subtotal;

        breakdown.push({
          label: stage.label + "（" + (schoolType === "public" ? "公立" : "私立") + "）",
          years: years,
          annual: annual,
          subtotal: subtotal
        });
      }

      var univType = config.universityType;
      if (univType && univType !== "none") {
        var univYears = 4;
        var annualUniv = costModel.university[univType];
        var subtotalUniv = annualUniv * univYears;
        total += subtotalUniv;

        var labelUniType = "";
        if (univType === "national") labelUniType = "国公立";
        if (univType === "private_arts") labelUniType = "私立文系";
        if (univType === "private_science") labelUniType = "私立理系";

        breakdown.push({
          label: "大学（学部・" + labelUniType + "）",
          years: univYears,
          annual: annualUniv,
          subtotal: subtotalUniv
        });

        var livingType = config.livingType || "home";
        var livingAnnual = costModel.living[livingType] || 0;
        if (livingAnnual > 0) {
          var livingSubtotal = livingAnnual * univYears;
          total += livingSubtotal;

          var livingLabel = "一人暮らし費（大学在学中）";
          if (livingType === "tokyo_rent") livingLabel = "首都圏一人暮らし費（大学在学中）";
          if (livingType === "local_rent") livingLabel = "地方都市一人暮らし費（大学在学中）";

          breakdown.push({
            label: livingLabel,
            years: univYears,
            annual: livingAnnual,
            subtotal: livingSubtotal
          });
        }
      }

      if (config.includeGraduate && univType && univType !== "none") {
        var gradYears = 2;
        var gradAnnual = costModel.graduate[univType];
        var gradSubtotal = gradAnnual * gradYears;
        total += gradSubtotal;

        breakdown.push({
          label: "大学院",
          years: gradYears,
          annual: gradAnnual,
          subtotal: gradSubtotal
        });

        var livingTypeGrad = config.livingType || "home";
        var livingAnnualGrad = costModel.living[livingTypeGrad] || 0;
        if (livingAnnualGrad > 0) {
          var livingSubtotalGrad = livingAnnualGrad * gradYears;
          total += livingSubtotalGrad;

          var livingLabelGrad = "一人暮らし費（大学院）";
          if (livingTypeGrad === "tokyo_rent") livingLabelGrad = "首都圏一人暮らし費（大学院）";
          if (livingTypeGrad === "local_rent") livingLabelGrad = "地方都市一人暮らし費（大学院）";

          breakdown.push({
            label: livingLabelGrad,
            years: gradYears,
            annual: livingAnnualGrad,
            subtotal: livingSubtotalGrad
          });
        }
      }

      // 追加オプション（塾・予備校・習い事）
      if (advancedFlags && advancedFlags.jukuElem) {
        var e1 = extrasModel.jukuElem;
        var r1 = calcExtras(currentIndex, e1);
        if (r1) {
          total += r1.subtotal;
          breakdown.push({
            label: e1.label,
            years: r1.years,
            annual: r1.annual,
            subtotal: r1.subtotal
          });
        }
      }
      if (advancedFlags && advancedFlags.jukuJh) {
        var e2 = extrasModel.jukuJh;
        var r2 = calcExtras(currentIndex, e2);
        if (r2) {
          total += r2.subtotal;
          breakdown.push({
            label: e2.label,
            years: r2.years,
            annual: r2.annual,
            subtotal: r2.subtotal
          });
        }
      }
      if (advancedFlags && advancedFlags.yobikou) {
        var e3 = extrasModel.yobikou;
        var r3 = calcExtras(currentIndex, e3);
        if (r3) {
          total += r3.subtotal;
          breakdown.push({
            label: e3.label,
            years: r3.years,
            annual: r3.annual,
            subtotal: r3.subtotal
          });
        }
      }
      if (advancedFlags && advancedFlags.lessons) {
        var e4 = extrasModel.lessons;
        var r4 = calcExtras(currentIndex, e4);
        if (r4) {
          total += r4.subtotal;
          breakdown.push({
            label: e4.label,
            years: r4.years,
            annual: r4.annual,
            subtotal: r4.subtotal
          });
        }
      }

      return { total: total, breakdown: breakdown };
    }

    function formatManYen(amount) {
      var man = amount / 10000;
      return man.toLocaleString("ja-JP", { maximumFractionDigits: 1 }) + "万円";
    }

    function showError(message) {
      var errorArea = document.getElementById("error-area");
      if (!message) {
        errorArea.style.display = "none";
        errorArea.textContent = "";
      } else {
        errorArea.style.display = "block";
        errorArea.textContent = message;
      }
    }

    function handleCalculate() {
      // 現在タブの内容を state に保存
      saveCurrentFormToState();

      var resultCard = document.getElementById("result-card");
      var resultMainText = document.getElementById("result-main-text");
      var resultSubText = document.getElementById("result-sub-text");
      var breakdownTableBody = document.querySelector("#breakdown-table tbody");
      var resultCardTitle = document.getElementById("result-card-title");

      var familyCard = document.getElementById("family-card");
      var familyMainText = document.getElementById("family-main-text");
      var familyTableBody = document.querySelector("#family-table tbody");

      showError("");

      // アクティブ子どものチェック
      var activeState = childStates[activeChildIndex];
      if (!activeState.gradeValue) {
        showError("アクティブな子どもの『今の学年』を選択してください。");
        resultCard.style.display = "none";
        familyCard.style.display = "none";
        return;
      }

      var childTotals = [];
      var familyTotal = 0;
      var activeResult = null;
      var activeConfig = null;

      for (var i = 0; i < childStates.length; i++) {
        var st = childStates[i];
        if (!st.gradeValue) continue; // 未設定の子どもはスキップ

        var currentIndex = parseInt(st.gradeValue, 10);

        var cfg = {
          kindergartenType: st.kindergartenType,
          elementaryType: st.elementaryType,
          juniorHighType: st.juniorType,
          highSchoolType: st.highType,
          universityType: st.universityType,
          livingType: st.livingType,
          includeGraduate: st.includeGraduate
        };

        var result = calculateEducationCost(currentIndex, cfg, st.advancedFlags);
        familyTotal += result.total;
        childTotals.push({
          index: i,
          total: result.total
        });

        if (i === activeChildIndex) {
          activeResult = result;
          activeConfig = cfg;
        }
      }

      if (!activeResult) {
        showError("アクティブな子どもの設定を確認してください。");
        resultCard.style.display = "none";
        familyCard.style.display = "none";
        return;
      }

      var childLabel = "子ども" + (activeChildIndex + 1);
      var displayName = activeState.name || childLabel;

      resultCardTitle.textContent = displayName + " の試算結果";

      resultMainText.innerHTML =
        '<span class="result-name">' + displayName +
        '</span>がこれから進学した場合の教育費は、' +
        '<span class="result-highlight">約 ' + formatManYen(activeResult.total) +
        '</span>程度と試算されます。';

      var summaryParts = [];

      summaryParts.push(
        "幼稚園：" + (activeState.kindergartenType === "public" ? "公立" : "私立") +
        " / 小学校：" + (activeState.elementaryType === "public" ? "公立" : "私立") +
        " / 中学校：" + (activeState.juniorType === "public" ? "公立" : "私立") +
        " / 高校：" + (activeState.highType === "public" ? "公立" : "私立")
      );

      if (activeConfig.universityType === "none") {
        summaryParts.push("大学：進学しない想定");
      } else if (activeConfig.universityType === "national") {
        summaryParts.push("大学：国公立");
      } else if (activeConfig.universityType === "private_arts") {
        summaryParts.push("大学：私立文系");
      } else if (activeConfig.universityType === "private_science") {
        summaryParts.push("大学：私立理系");
      }

      if (activeConfig.universityType !== "none") {
        if (activeConfig.livingType === "home") {
          summaryParts.push("居住：自宅通学");
        } else if (activeConfig.livingType === "local_rent") {
          summaryParts.push("居住：地方都市一人暮らし");
        } else if (activeConfig.livingType === "tokyo_rent") {
          summaryParts.push("居住：首都圏一人暮らし");
        }
      }

      if (activeConfig.includeGraduate) {
        summaryParts.push("大学院：進学あり（2年）");
      } else {
        summaryParts.push("大学院：進学なし");
      }

      resultSubText.textContent = summaryParts.join(" / ");

      // 個別内訳
      breakdownTableBody.innerHTML = "";
      var breakdown = activeResult.breakdown;
      if (!breakdown || breakdown.length === 0) {
        var trEmpty = document.createElement("tr");
        var tdEmpty = document.createElement("td");
        tdEmpty.colSpan = 4;
        tdEmpty.style.textAlign = "center";
        tdEmpty.textContent = "これからかかる教育費は、選択された条件ではほとんどありません。";
        trEmpty.appendChild(tdEmpty);
        breakdownTableBody.appendChild(trEmpty);
      } else {
        for (var j = 0; j < breakdown.length; j++) {
          var row = breakdown[j];
          var tr = document.createElement("tr");

          var tdLabel = document.createElement("td");
          tdLabel.textContent = row.label;

          var tdYears = document.createElement("td");
          tdYears.textContent = row.years ? (row.years + "年") : "";

          var tdAnnual = document.createElement("td");
          tdAnnual.textContent = row.annual ? formatManYen(row.annual) : "";

          var tdSubtotal = document.createElement("td");
          tdSubtotal.textContent = formatManYen(row.subtotal);

          tr.appendChild(tdLabel);
          tr.appendChild(tdYears);
          tr.appendChild(tdAnnual);
          tr.appendChild(tdSubtotal);

          breakdownTableBody.appendChild(tr);
        }
      }

      resultCard.style.display = "block";

      // 家族合計
      if (childTotals.length > 0) {
        familyTableBody.innerHTML = "";
        for (var k = 0; k < childTotals.length; k++) {
          var ct = childTotals[k];
          var idx = ct.index;
          var st2 = childStates[idx];
          var label = st2.name || ("子ども" + (idx + 1));

          var trF = document.createElement("tr");
          var tdName = document.createElement("td");
          tdName.textContent = label;
          var tdTotal = document.createElement("td");
          tdTotal.textContent = formatManYen(ct.total);

          trF.appendChild(tdName);
          trF.appendChild(tdTotal);
          familyTableBody.appendChild(trF);
        }

        familyMainText.innerHTML =
          "登録されている " + childTotals.length + "人分の教育費の合計は、" +
          '<span class="result-highlight">約 ' + formatManYen(familyTotal) +
          '</span>程度と試算されます。';

        familyCard.style.display = "block";
      } else {
        familyCard.style.display = "none";
      }

      resultCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    document.addEventListener("DOMContentLoaded", function() {
      initChildStates();
      updateTabUI();
      loadStateToForm();
    });
  </script>
</body>
</html>
